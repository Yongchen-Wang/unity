# start_both_programs_yolo.py 数据流动关系详细说明

## 📋 系统架构概览

运行 `start_both_programs_yolo.py` 后，系统会启动三个核心程序，与 Unity 场景配合形成一个完整的数据采集和控制闭环系统。

**系统组件：**
- **Python 端**：3个核心程序（控制、检测、记录）
- **Unity 端**：3个核心脚本（发送、接收、显示）

---

## 🚀 启动顺序

1. **预设UMP位置** (run_keyboard_preset)
   - 移动右臂到 (20000, 20000, 18000)
   - 移动左臂到 (0, 6000, 18000)
   - 等待8秒完成运动

2. **启动控制程序** (geomagic_control.py)
   - 窗口1：Sensapex控制程序

3. **启动数据记录器** (robot_data_logger.py)
   - 窗口2：TCP服务器，监听端口5007
   - 等待3秒确保服务器完全启动

4. **启动摄像头检测程序** (camera_tcp_magnet_yolo.py)
   - 窗口3：YOLO检测程序，TCP客户端
   - 连接到robot_data_logger.py的5007端口

---

## 🔄 数据流动关系图

```
┌─────────────────────────────────────────────────────────────────┐
│                        Unity 场景 (VR_robotic)                    │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  HapticUDPTwoHand.cs                                     │   │
│  │  - 读取 Geomagic Touch 手柄位置                           │   │
│  │  - 计算位移增量 (dx, dy, dz)                              │   │
│  │  - UDP发送到 geomagic_control.py (端口5005)              │   │
│  │  - 发送 START/STOP 命令到 robot_data_logger (TCP 5008)   │   │
│  └────────┬──────────────────────────────────────────────────┘   │
│           │                                                       │
│           │ UDP 5005 (发送 Geomagic Touch 位移)                  │
│           │                                                       │
│  ┌────────┴──────────────────────────────────────────────────┐   │
│  │  RobotUDPReceiver.cs                                      │   │
│  │  - UDP接收 geomagic_control.py (端口5006)                 │   │
│  │  - 接收 UMP 机械臂位移 (dx, dy)                            │   │
│  │  - 控制 Unity 场景中的机器人模型移动                        │   │
│  └────────┬──────────────────────────────────────────────────┘   │
│           │                                                       │
│  ┌────────┴──────────────────────────────────────────────────┐   │
│  │  TCPReceiver.cs                                           │   │
│  │  - TCP接收磁铁位置 (端口5006)                              │   │
│  │  - 接收格式: "x,y,z\n"                                    │   │
│  │  - 更新 latestPosition 供其他脚本使用                       │   │
│  └────────┬──────────────────────────────────────────────────┘   │
└───────────┼───────────────────────────────────────────────────────┘
            │
            │ UDP 5005 (Geomagic Touch 位移)
            │
            ▼
┌──────────────────────────────────────────────┼───────────────────┐
│         geomagic_control.py                  │                    │
│  ┌──────────────────────────────────────┐    │                    │
│  │  线程1: read_and_send()             │    │                    │
│  │  - 读取UMP位置 (60Hz)                │    │                    │
│  │  - 计算位移 (dx, dy)                  │    │                    │
│  │  - UDP发送到Unity 5006                │    │                    │
│  └──────────────────────────────────────┘    │                    │
│                                              │                    │
│  ┌──────────────────────────────────────┐    │                    │
│  │  线程2: receive_geomagic_and_control()│    │                    │
│  │  - UDP接收Unity 5005 (Geomagic数据)   │    │                    │
│  │  - 控制UMP机械臂运动                   │    │                    │
│  │  - 计算位置差值和速度                   │    │                    │
│  │  - TCP发送到robot_data_logger 5009    │    │                    │
│  └──────────────┬───────────────────────┘    │                    │
└─────────────────┼─────────────────────────────┼───────────────────┘
                  │                             │
                  │ TCP 5009                    │
                  │ (位置差值+速度)              │
                  ▼                             │
┌──────────────────────────────────────────────┼───────────────────┐
│         robot_data_logger.py                 │                    │
│  ┌──────────────────────────────────────┐    │                    │
│  │  TCP服务器 (端口5007)                 │    │                    │
│  │  - 接收camera_tcp_magnet_yolo.py     │    │                    │
│  │  - 接收磁铁位置 (x, y)                │    │                    │
│  │  - 计算速度 (vx, vy)                  │    │                    │
│  │  - 查询distance_to_boundary           │    │                    │
│  │  - 读取FSR力传感器数据                 │    │                    │
│  └──────────────────────────────────────┘    │                    │
│                                              │                    │
│  ┌──────────────────────────────────────┐    │                    │
│  │  TCP服务器 (端口5009)                 │    │                    │
│  │  - 接收geomagic_control.py            │    │                    │
│  │  - 接收位置差值 (error_x, error_y)    │    │                    │
│  │  - 接收速度 (vx, vy)                   │    │                    │
│  └──────────────────────────────────────┘    │                    │
│                                              │                    │
│  ┌──────────────────────────────────────┐    │                    │
│  │  控制服务器 (端口5008)                │    │                    │
│  │  - 接收START/STOP命令                 │    │                    │
│  │  - 控制数据记录开始/停止                │    │                    │
│  └──────────────────────────────────────┘    │                    │
│                                              │                    │
│  ┌──────────────────────────────────────┐    │                    │
│  │  数据记录功能                         │    │                    │
│  │  - 合并所有数据源                      │    │                    │
│  │  - 写入robot_data/*.csv               │    │                    │
│  └──────────────────────────────────────┘    │                    │
└──────────────────────────────────────────────┼───────────────────┘
                                               │
                                               │ TCP 5006
                                               │ (磁铁位置转发)
                                               ▼
┌─────────────────────────────────────────────────────────────────┐
│         camera_tcp_magnet_yolo.py                                 │
│  ┌────────────────────────────────────────────────────────────┐   │
│  │  摄像头采集 (1280x720, 30fps)                             │   │
│  │  - 读取摄像头画面                                          │   │
│  │  - YOLO实例分割检测磁铁                                    │   │
│  │  - 计算质心位置 (pixel_x, pixel_y)                        │   │
│  │  - 坐标转换 (pixel → 物理空间 mm)                         │   │
│  │  - 追踪器平滑处理                                          │   │
│  │  - TCP发送到robot_data_logger 5007                        │   │
│  │  - TCP发送到Unity 5007 (如果Unity作为TCP服务器)           │   │
│  └────────────────────────────────────────────────────────────┘   │
└───────────────────────────────────────────────────────────────────┘
```

---

## 🎮 Unity 脚本说明

### HapticUDPTwoHand.cs
**位置**: `VR_robotic/Assets/Scripts/HapticUDPTwoHand.cs`  
**功能**: 
- 读取 Geomagic Touch 手柄位置（HPluginL/R.CurrentPosition）
- 计算位移增量（当前帧位置 - 上一帧位置）
- UDP 发送到 `geomagic_control.py` (端口 5005)
- 自动发送 START/STOP 命令到 `robot_data_logger.py` (TCP 5008)

**关键配置**:
- `HPluginL`: 左臂 Geomagic Touch 手柄组件
- `HPluginR`: 右臂 Geomagic Touch 手柄组件
- `remoteEndPoint`: `127.0.0.1:5005` (UDP)
- `LoggerHost`: `127.0.0.1` (TCP 5008)

**数据格式**: `"L,dx,dy,dz"` 或 `"R,dx,dy,dz"`  
**发送频率**: 每 0.1 秒（按钮按下时）

---

### RobotUDPReceiver.cs
**位置**: `VR_robotic/Assets/Scripts/RobotUDPReceiver.cs`  
**功能**:
- UDP 接收来自 `geomagic_control.py` 的数据（端口 5006）
- 解析消息并控制 Unity 场景中的机器人模型移动
- 支持左右臂分别控制

**关键配置**:
- `leftRobotFrontBack`: 左臂前后移动的 GameObject 列表
- `leftRobotLeftRight`: 左臂左右移动的 GameObject 列表
- `leftRobotUpDown`: 左臂上下移动的 GameObject 列表
- `rightRobotFrontBack`: 右臂前后移动的 GameObject 列表
- `rightRobotLeftRight`: 右臂左右移动的 GameObject 列表
- `rightRobotUpDown`: 右臂上下移动的 GameObject 列表

**数据格式**: `"L,dx,dy,dz"` 或 `"R,dx,dy,dz"`  
**接收频率**: 60Hz（与 `geomagic_control.py` 同步）

---

### TCPReceiver.cs
**位置**: `VR_robotic/Assets/TCPReceiver.cs`  
**功能**:
- TCP 服务器，监听端口 5006
- 接收来自 `camera_tcp_magnet_yolo.py` 的磁铁位置数据
- 更新静态变量 `latestPosition` 供其他脚本使用

**关键配置**:
- `listenPort`: 5006
- `latestPosition`: 静态 Vector3 变量，存储最新磁铁位置

**数据格式**: `"x,y,z\n"`  
**接收频率**: 摄像头帧率（约 30fps）

---

## 📊 详细数据流说明

### 1️⃣ Unity → geomagic_control.py

**Unity 脚本**: `HapticUDPTwoHand.cs`  
**通信方式**: UDP  
**端口**: 5005 (geomagic_control.py 接收)  
**数据格式**: `"L,dx,dy,dz"` 或 `"R,dx,dy,dz"`  
**频率**: Unity每0.1秒发送一次（按钮按下时）  
**内容**: Geomagic Touch手柄的位移增量

**Unity 端处理流程**:
```
HapticUDPTwoHand.cs:
→ 读取 Geomagic Touch 手柄当前位置 (HPluginL/R.CurrentPosition)
→ 计算位移增量 = 当前位置 - 上次位置
→ 格式化消息: "L,dx,dy,dz" 或 "R,dx,dy,dz"
→ UDP发送到 127.0.0.1:5005
→ 每0.1秒发送一次（按钮按下时）
```

**Python 端处理流程**:
```
geomagic_control.py接收 (UDP 5005)
→ 解析hand, dx, dz, dy
→ 控制UMP机械臂运动
→ 计算位置差值和速度
→ 发送到robot_data_logger (TCP 5009)
```

**关键代码位置**:
- Unity: `VR_robotic/Assets/Scripts/HapticUDPTwoHand.cs` (第180-219行)
- Python: `geomagic_control.py` (第139-156行)

---

### 2️⃣ geomagic_control.py → Unity

**Unity 脚本**: `RobotUDPReceiver.cs`  
**通信方式**: UDP  
**端口**: 5006 (Unity 接收)  
**数据格式**: `"L,dx,dy"` 或 `"R,dx,dy"`  
**频率**: 60Hz (每16.67ms)  
**内容**: UMP机械臂的位移增量（仅x, y方向）

**Python 端处理流程**:
```
geomagic_control.py读取UMP位置 (60Hz)
→ 计算位移 (dx, dy)
→ UDP发送到Unity 5006
→ 格式: "L,dx,dy" 或 "R,dx,dy"
```

**Unity 端处理流程**:
```
RobotUDPReceiver.cs接收 (UDP 5006)
→ 解析消息: identifier, moveX, moveY, moveZ
→ 根据 identifier ("L" 或 "R") 选择对应的机器人模型
→ 移动机器人部件:
  - leftRobotFrontBack/rightRobotFrontBack (前后移动)
  - leftRobotLeftRight/rightRobotLeftRight (左右移动)
  - leftRobotUpDown/rightRobotUpDown (上下移动)
```

**关键代码位置**:
- Python: `geomagic_control.py` (第105-137行)
- Unity: `VR_robotic/Assets/Scripts/RobotUDPReceiver.cs` (第94-116行)

---

### 3️⃣ camera_tcp_magnet_yolo.py → robot_data_logger.py

**通信方式**: TCP  
**端口**: 5007 (robot_data_logger作为服务器)  
**数据格式**: `"x,y,z\n"` (x, y已放大scale_factor=100倍)  
**频率**: 摄像头帧率（约30fps）  
**内容**: 磁铁的质心位置（物理坐标，单位mm）

**处理流程**:
```
摄像头采集画面 (1280x720)
→ YOLO模型检测 (640x640输入)
→ 提取分割掩码
→ 计算质心 (pixel坐标)
→ 坐标转换 (pixel → 物理空间mm)
→ 追踪器平滑处理
→ TCP发送到robot_data_logger 5007
```

**坐标转换**:
- 使用 `calibration_params.json` 中的标定参数
- 从像素坐标转换为物理空间坐标（mm）
- 应用scale_factor=100放大后发送

---

### 4️⃣ geomagic_control.py → robot_data_logger.py

**通信方式**: TCP  
**端口**: 5009 (robot_data_logger作为服务器)  
**数据格式**: 
- 位置差值: `"ERROR,hand,error_x_mm,error_y_mm,timestamp\n"`
- 速度: `"VELOCITY,hand,vx_mm_s,vy_mm_s,timestamp\n"`  
**频率**: 与Geomagic Touch数据同步（按钮按下时）  
**内容**: 
- 位置差值：Geomagic Touch位移与UMP实际位移的差值
- 速度：Geomagic Touch的运动速度

**计算过程**:
```
接收Geomagic Touch位移 (dx, dz)
→ 累积位移 (cumulative_dx, cumulative_dz)
→ 转换为UMP坐标系
→ 获取UMP当前位置
→ 计算差值 = Geomagic位移 - UMP位移
→ 转换为mm单位
→ TCP发送到robot_data_logger 5009
```

---

### 5️⃣ robot_data_logger.py 数据整合

**接收的数据源**:
1. **磁铁位置** (TCP 5007): 来自camera_tcp_magnet_yolo.py
2. **位置差值** (TCP 5009): 来自geomagic_control.py
3. **速度数据** (TCP 5009): 来自geomagic_control.py
4. **FSR力传感器** (串口COM15): 实时读取

**处理流程**:
```
接收磁铁位置 (TCP 5007)
→ 计算速度 (vx, vy)
→ 查询distance_to_boundary (从distance_dataset.csv)
→ 接收位置差值和速度 (TCP 5009)
→ 读取FSR数据 (串口)
→ 合并所有数据（使用统一时间戳）
→ 写入robot_data/*.csv
```

**CSV文件格式**:
```
timestamp, magnet_x, magnet_y, magnet_vx, magnet_vy, 
distance_to_boundary, error_x, error_y, geomagic_vx, geomagic_vy,
fsr_force, ...
```

---

### 6️⃣ camera_tcp_magnet_yolo.py → Unity (磁铁位置)

**Unity 脚本**: `TCPReceiver.cs`  
**通信方式**: TCP  
**端口**: 5006 (Unity 作为 TCP 服务器)  
**数据格式**: `"x,y,z\n"`  
**频率**: 摄像头帧率（约30fps）  
**内容**: 磁铁的质心位置（物理坐标，单位mm）

**Python 端处理流程**:
```
camera_tcp_magnet_yolo.py:
→ 检测磁铁位置
→ 坐标转换 (pixel → 物理空间mm)
→ TCP发送到Unity 5006
→ 格式: "x,y,z\n"
```

**Unity 端处理流程**:
```
TCPReceiver.cs接收 (TCP 5006):
→ 监听端口 5006
→ 接收数据并解析: "x,y,z\n"
→ 更新 latestPosition (静态变量)
→ 供其他 Unity 脚本使用（如可视化磁铁位置）
```

**关键代码位置**:
- Python: `camera_tcp_magnet_yolo.py` (第195-244行)
- Unity: `VR_robotic/Assets/TCPReceiver.cs` (第96-126行)

**注意**: 
- Unity 的 `TCPReceiver.cs` 监听端口 5006，接收磁铁位置数据
- `latestPosition` 是静态变量，可以在其他 Unity 脚本中直接访问
- 如果 `robot_data_logger.py` 需要转发数据，也可以连接到 Unity 的 TCP 5006 端口

---

## 🔌 端口使用总结

| 端口 | 协议 | 方向 | Unity脚本 | Python脚本 | 用途 |
|------|------|------|-----------|-------------|------|
| 5005 | UDP | Unity → Python | HapticUDPTwoHand.cs | geomagic_control.py | Geomagic Touch位移数据 |
| 5006 | UDP | Python → Unity | RobotUDPReceiver.cs | geomagic_control.py | UMP机械臂位移数据 |
| 5006 | TCP | Python → Unity | TCPReceiver.cs | camera_tcp_magnet_yolo.py | 磁铁位置数据 |
| 5007 | TCP | Python → Python | - | camera_tcp_magnet_yolo.py → robot_data_logger.py | 磁铁位置数据 |
| 5008 | TCP | Unity → Python | HapticUDPTwoHand.cs | robot_data_logger.py | START/STOP命令 |
| 5009 | TCP | Python → Python | - | geomagic_control.py → robot_data_logger.py | 位置差值和速度数据 |

---

## 📁 文件输出

### robot_data_logger.py 输出
- `robot_data/robot_data_YYYYMMDD_HHMMSS.csv`: 综合数据
  - 包含：磁铁位置、速度、位置差值、FSR力等所有数据源
  - 格式：`timestamp, magnet_x, magnet_y, magnet_vx, magnet_vy, distance_to_boundary, error_x, error_y, geomagic_vx, geomagic_vy, fsr_force, ...`

**注意**: `geomagic_control.py` 不再单独记录数据，所有数据统一由 `robot_data_logger.py` 记录。

---

## ⚙️ 关键参数配置

### geomagic_control.py
- `SCALE_FACTOR = 200`: Geomagic Touch到UMP的缩放比例
- `SEND_INTERVAL = 1.0/60.0`: UDP发送频率（60Hz）
- `UMP_INITIAL_POS = (7000, 7000, 20000)`: UMP初始位置

### camera_tcp_magnet_yolo.py
- `scale_factor = 100`: 坐标放大倍数（发送前放大）
- `conf_threshold = 0.392`: YOLO置信度阈值
- `imgsz = 640`: YOLO输入图像尺寸

### robot_data_logger.py
- `tcp_port = 5007`: TCP服务器端口
- `scale_factor = 100`: 坐标还原倍数（接收后除以100）
- `fsr_port = 'COM15'`: FSR串口

---

## 🔄 数据同步机制

1. **时间戳统一**: 所有数据使用 `time.time()` 获取统一时间戳
2. **TCP可靠传输**: 磁铁位置和差值数据使用TCP确保不丢失
3. **UDP实时传输**: UMP位移数据使用UDP保证低延迟
4. **线程安全**: 使用锁机制保护共享变量

---

## 🎯 系统工作流程

1. **初始化阶段**:
   - 启动三个Python程序
   - 建立TCP连接（camera → logger）
   - 启动Unity场景
   - Unity脚本自动连接（UDP/TCP）

2. **运行阶段**:
   - **Unity → Python**: `HapticUDPTwoHand.cs` 发送Geomagic Touch数据 → `geomagic_control.py` 控制UMP运动
   - **Python → Unity**: `geomagic_control.py` 发送UMP位移 → `RobotUDPReceiver.cs` 更新机器人模型
   - **Python → Unity**: `camera_tcp_magnet_yolo.py` 发送磁铁位置 → `TCPReceiver.cs` 更新磁铁可视化
   - **Python → Python**: 摄像头检测磁铁位置 → 记录到logger
   - **Python → Python**: 计算位置差值和速度 → 记录到logger
   - **Unity → Python**: `HapticUDPTwoHand.cs` 发送START/STOP命令 → `robot_data_logger.py` 控制记录
   - 所有数据合并写入CSV

3. **停止阶段**:
   - Unity发送STOP命令到logger（或手动按Enter）
   - 关闭所有连接
   - 保存CSV文件

---

## 📝 注意事项

1. **启动顺序很重要**: 
   - 必须先启动 `robot_data_logger.py`（TCP服务器），再启动 `camera_tcp_magnet_yolo.py`（TCP客户端）
   - Unity场景可以在Python程序启动后启动

2. **端口冲突**: 
   - 确保5007端口未被占用（robot_data_logger.py）
   - 确保5006端口未被占用（Unity TCPReceiver.cs）

3. **Unity脚本配置**:
   - `HapticUDPTwoHand.cs`: 需要配置 HPluginL 和 HPluginR（Geomagic Touch手柄）
   - `RobotUDPReceiver.cs`: 需要配置机器人模型的GameObject列表
   - `TCPReceiver.cs`: 自动启动，无需额外配置

4. **数据记录**: 
   - `robot_data_logger.py` 需要按Enter开始记录数据
   - 或通过Unity的 `HapticUDPTwoHand.cs` 自动发送START命令

5. **YOLO模型**: 确保模型文件路径正确

6. **Unity按钮控制**: 
   - Geomagic Touch手柄按钮按下时，`HapticUDPTwoHand.cs` 才会发送数据
   - 按钮释放时停止发送

---

## 🔍 调试建议

1. **检查端口占用**: `netstat -ano | findstr :5007`
2. **查看TCP连接**: 确认camera成功连接到logger
3. **验证UDP数据**: 检查Unity和geomagic_control.py之间的UDP通信
4. **检查CSV文件**: 确认数据正确写入
5. **查看日志输出**: 各程序窗口会显示连接状态和错误信息
